// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================================
// 1. MANAJEMEN PROPERTI & USER (RBAC)
// =========================================

model Property {
  id     String  @id @default(cuid())
  name   String  @unique // "Penginapan RM" atau "Raudlatul Jannah"
  isFree Boolean @default(false) 

  rooms      Room[]
  users      UserProperty[]
}

model User {
  id        String    @id @default(cuid())
  name      String
  username  String    @unique
  password  String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  roleId    String
  role      Role      @relation(fields: [roleId], references: [id])
  
  properties UserProperty[]

  // Relasi Log Aktivitas
  checkedInBookings  Booking[] @relation("CheckedInBy")
  checkedOutBookings Booking[] @relation("CheckedOutBy")
}

model UserProperty {
  userId     String
  propertyId String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@id([userId, propertyId])
}

model Role {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  users       User[]
  permissions RolePermission[]
}

model Permission {
  id          String    @id @default(cuid())
  name        String    @unique 
  description String?
  roles       RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

// =========================================
// 2. MANAJEMEN KAMAR
// =========================================

model Room {
  id          String   @id @default(cuid())
  roomNumber  String   @unique
  floor       Int
  
  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id])

  roomTypeId  String?
  roomType    RoomType? @relation(fields: [roomTypeId], references: [id])
  
  status      RoomStatus @default(AVAILABLE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  images      RoomImage[]
  bookings    Booking[]
}

enum RoomStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
}

model RoomType {
  id            String @id @default(cuid())
  name          String @unique
  priceHalfDay  Float
  priceFullDay  Float
  
  rooms         Room[]
}

model RoomImage {
  id        String   @id @default(cuid())
  url       String   // URL Gambar (Cloudinary Secure URL)
  publicId  String?  // [BARU] ID Gambar di Cloudinary (untuk delete)
  roomId    String
  createdAt DateTime @default(now())

  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
}

// =========================================
// 3. TRANSAKSI & BOOKING (CORE UPGRADE)
// =========================================

model Booking {
  id                 String       @id @default(cuid())
  
  // Data Tamu
  guestName          String       
  guestPhone         String?
  studentName        String
  addressId          String?      
  addressLabel       String?

  // Waktu Menginap
  checkIn            DateTime     @default(now())
  checkOut           DateTime?    // Diisi saat tamu pulang (Real checkout)
  expectedCheckOut   DateTime     // Rencana pulang (untuk hitung denda)
  
  // Paket & Durasi
  bookingType        BookingType  // HALF_DAY atau FULL_DAY (Basis hitungan)
  durationInDays     Int          @default(0) // Jumlah hari penuh (misal: 2 hari)
  isExtraHalfDay     Boolean      @default(false) // [BARU] Tambahan setengah hari? (misal: 2.5 hari)

  // Keuangan
  baseFee            Float        // Biaya Kamar (Fix saat check-in)
  lateFee            Float?       // Denda Waktu (Dihitung di backend saat checkout)
  itemChargeFee      Float?       // [BARU] Total Denda Barang (agar query cepat)
  totalFee           Float        // Total Tagihan (Base + Late + Item)
  
  amountPaid         Float        @default(0) // [BARU] Uang yang sudah dibayar (DP)
  
  paymentMethod      PaymentMethod?
  paymentStatus      PaymentStatus @default(UNPAID) // Lunas/Belum/Sebagian

  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  // Relasi
  roomId             String
  room               Room         @relation(fields: [roomId], references: [id])
  
  checkedInById      String
  checkedInBy        User         @relation("CheckedInBy", fields: [checkedInById], references: [id])
  
  checkedOutById     String?
  checkedOutBy       User?        @relation("CheckedOutBy", fields: [checkedOutById], references: [id])
  
  // Relasi ke denda barang (Many-to-Many via tabel penghubung)
  charges            BookingCharge[]
}

enum PaymentMethod {
  CASH
  TRANSFER
}

enum PaymentStatus {
  PAID    // Lunas
  UNPAID  // Belum Bayar
  PARTIAL // [BARU] Bayar Sebagian (DP)
}

enum BookingType {
  HALF_DAY 
  FULL_DAY 
}

// =========================================
// 4. DENDA BARANG (MANAGEABLE VIA ADMIN)
// =========================================

// Master Data Barang Denda (Admin bisa CRUD ini)
model ChargeableItem {
  id           String  @id @default(cuid())
  itemName     String  @unique // Contoh: "Kunci Hilang", "Bantal Rusak"
  chargeAmount Float           // Contoh: 50000

  bookings     BookingCharge[]
}

// Pencatatan Denda pada Booking tertentu
model BookingCharge {
  id               String @id @default(cuid())
  quantity         Int    @default(1)
  
  bookingId        String
  booking          Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  chargeableItemId String
  chargeableItem   ChargeableItem @relation(fields: [chargeableItemId], references: [id])
  
  // Menyimpan harga saat kejadian (snapshot), jaga-jaga kalau harga master berubah
  chargeAtMoment   Float? 
}